---
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMCluster
metadata:
  name: vmcluster
  namespace: monitoring
spec:
  # Duration to keep metrics
  retentionPeriod: "2" # this is months unless a character prefix is added (1d, 1w, etc)
  extraArgs:
    dedup.minScrapeInterval: "60s" # Only needed for HA
  replicationFactor: 3
  # Storage backend
  vmstorage:
    replicaCount: 3 # HA - but prefer 3 as i have 3 nodes & using local-hostpath
    # required for HA vmagents
    extraArgs:
      dedup.minScrapeInterval: 60s # Only needed for HA
      search.maxConcurrentRequests: "6"
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: ceph-block
          resources:
            requests:
              storage: 10Gi
  # Query backend
  vmselect:
    replicaCount: 2 # HA
    cacheMountPath: /select-cache
    extraArgs:
      dedup.minScrapeInterval: "60s" # should be equal to VMAgent's scrapeInterval (default 30s)
      search.minStalenessInterval: "5m"
      search.maxConcurrentRequests: "6"
      vmalert.proxyURL: "http://vmalert.${EXTERNAL_DOMAIN}"
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: ceph-block
          resources:
            requests:
              storage: 2Gi
  # Data ingestion backend
  vminsert:
    replicaCount: 2 # HA
    extraArgs:
      maxLabelsPerTimeseries: "90" # More needed if you are scraping a LOT of stuff and having issues
      # insert.maxConcurrentRequests: 10
    resources:
      requests:
        cpu: 105m
        memory: 300Mi
      limits:
        memory: 600Mi
