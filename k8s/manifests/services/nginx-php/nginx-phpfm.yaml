---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: nginx-phpfm
  namespace: services
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://drpsychick.github.io/charts
      chart: nginx-phpfpm
      version: 0.0.3
      sourceRef:
        kind: HelmRepository
        name: drpsychick-charts
        namespace: flux-system
      interval: 5m
  install:
    remediation: # perform remediation when helm install fails
      retries: 3
  upgrade:
    remediation: # perform remediation when helm upgrade fails
      retries: 3
      remediateLastFailure: true # remediate the last failure, when no retries remain
    cleanupOnFail: true

  # Values link: https://github.com/DrPsychick/charts/blob/master/drpsychick/nginx-phpfpm/values.yaml
  values:
    nginx:
      image:
        tag: "1.21.0"
    phpfpm:
      image:
        # Custom container, php with mysql installed
        registry: ghcr.io/truxnell/container-images
        repository: php-mysql
        tag: "v7.2-fpm-mysql"

    ingress:
      enabled: true
      annotations:
        kubernetes.io/ingress.class: traefik
        cert-manager.io/cluster-issuer: ${CLUSTER_CERT}
        external-dns/is-public: "false"
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        traefik.ingress.kubernetes.io/router.middlewares: network-system-rfc1918-ips@kubernetescrd
        hajimari.io/enable: "false"

      hosts:
        - host: &host nginx.${CLUSTER_DOMAIN}
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - *host
          secretName: &tls nginx-${CLUSTER_NAME}-tls

    persistence:
      enabled: true
      existingClaim: nginx-php-config-v1
    podAnnotations:
      backup.velero.io/backup-volumes: root
    #   pre.hook.backup.velero.io/container: fsfreeze
    #   pre.hook.backup.velero.io/command: '["/sbin/fsfreeze", "--freeze", "/var/www/html"]'
    #   post.hook.backup.velero.io/container: fsfreeze
    #   post.hook.backup.velero.io/command: '["/sbin/fsfreeze", "--unfreeze", "/var/www/html"]'
    #   secret.reloader.stakater.com/reload: "home-assistant"
    # additionalContainers:
    #   fsfreeze:
    #     name: fsfreeze
    #     image: ghcr.io/k8s-at-home/fsfreeze:v2.37-r0
    #     volumeMounts:
    #       - name: root
    #         mountPath: /var/www/html
    #     securityContext:
    #       privileged: true
